function rand(e,t){return Math.floor(Math.random()*(t-e+1))+e}function rand(e,t){return Math.floor(Math.random()*(t-e+1))+e}var Game={w:1600,h:1200};null===localStorage.getItem("atPlayer")&&localStorage.setItem("atPlayer",rand(0,1e6)),Game.Boot=function(e){this.game=e},Game.Boot.prototype={preload:function(){this.game.stage.backgroundColor="#FFF",this.game.load.image("loading","assets/images/loading.png"),this.game.load.image("title","assets/images/title.png"),this.game.load.image("instructions","assets/images/instructions.png"),this.game.load.bitmapFont("minecraftia","assets/fonts/font.png","assets/fonts/font.xml"),this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.scale.maxHeight=window.innerHeight,this.game.scale.maxWidth=window.innerHeight*(Game.w/Game.h)},create:function(){this.game.state.start("Load")}},Game.Load=function(e){this.game=e},Game.Load.prototype={preload:function(){var e=(this.game.add.bitmapText(Game.w/2,Game.h/2,"minecraftia","Loading...",30).anchor.setTo(.5),this.game.add.sprite(Game.w/2-64,Game.h/2+50,"loading"));this.game.load.setPreloadSprite(e),this.game.load.image("twitter","assets/images/twitter.png"),this.game.load.image("pbullet","assets/images/pbullet.png"),this.game.load.image("ebullet","assets/images/ebullet.png"),this.game.load.image("background","assets/images/background.png"),this.game.load.audio("shot","assets/audio/fw2_energygun.wav"),this.game.load.audio("explosion","assets/audio/explosion.wav"),this.game.load.audio("oscillation","assets/audio/oscillation.wav")},create:function(){this.game.state.start("Menu")}};var Actor=function(e,t,a,i){this.game=e;var s=32;this.color=i;var r=this.game.add.bitmapData(s,s);r.ctx.clearRect(0,0,s,s),r.ctx.strokeStyle="#FFF",r.ctx.fillStyle=i,r.ctx.lineWidth=2,r.ctx.beginPath(),r.ctx.moveTo(s,s/2),r.ctx.lineTo(0,0),r.ctx.lineTo(0,s),r.ctx.lineTo(s,s/2),r.ctx.fill(),Phaser.Sprite.call(this,e,t,a,r),this.healthBar=this.game.add.sprite(this.x,this.y-52,this.makeBox(80,7,"#00ff00")),this.healthBar.anchor.setTo(.5),this.anchor.setTo(.5),this.passengers=0,this.game.physics.enable(this,Phaser.Physics.ARCADE),this.body.maxVelocity.set(500),this.body.collideWorldBounds=!0,this.scale.x=1.2,this.scale.y=1.2,this.fireRate=250,this.nextFire=0,this.health=20,this.game.camera.follow(this,Phaser.Camera.FOLLOW_TOPDOWN),this.game.add.existing(this)};Actor.prototype=Object.create(Phaser.Sprite.prototype),Actor.prototype.makeBox=function(e,t,a){var i=this.game.add.bitmapData(e,t);return i.ctx.beginPath(),i.ctx.rect(0,0,e,t),i.ctx.fillStyle=a,i.ctx.fill(),i},Actor.prototype.update=function(){this.healthBar.x=this.x,this.healthBar.y=this.y-52,this.healthBar.scale.x=this.health/10},Actor.prototype.constructor=Actor,Game.Menu=function(e){this.game=e},Game.Menu.prototype={create:function(){this.space=this.game.add.tileSprite(0,0,1600,1200,"background"),this.titleText=this.game.add.bitmapText(Game.w/2,Game.h/2-100,"minecraftia","Space Duel",128),this.titleText.anchor.setTo(.5),this.titleText.tint=16776960,this.game.add.tween(this.titleText).to({y:300},2e3,Phaser.Easing.Linear.In,!0,0,-1).yoyo(!0),this.instructions=this.game.add.sprite(Game.w/2+600,Game.h/2,"instructions"),this.instructions.anchor.setTo(.5);this.game.add.bitmapText(Game.w/2,Game.h/2+50,"minecraftia","~click to start~",48).anchor.setTo(.5)},update:function(){this.game.input.activePointer.isDown&&this.game.state.start("Play")}};var wKey,aKey,sKey,dKey,cursors,score=0,player,actors={},posUpdateTimer,enemyBullets;Game.Play=function(e){this.game=e},Game.Play.prototype={create:function(){this.game.world.setBounds(0,0,Game.w,Game.h),this.game.stage.backgroundColor="#000",this.space=this.game.add.tileSprite(0,0,1600,1200,"background"),this.stage.disableVisibilityChange=!0,this.pShotSnd=this.game.add.sound("shot"),this.pShotSnd.volume=.2,this.explosionSnd=this.game.add.sound("explosion"),this.oscSnd=this.game.add.sound("oscillation"),this.oscSnd.volume=.2,this.oscSnd.loop=!0,this.oscSnd.play(),this.deathTimer=this.game.time.now,this.fireRef=new Firebase("https://week12.firebaseio.com/"),enemyBullets=game.add.group(),enemyBullets.enableBody=!0,enemyBullets.physicsBodyType=Phaser.Physics.ARCADE,enemyBullets.createMultiple(100,"ebullet"),enemyBullets.setAll("anchor.x",.5),enemyBullets.setAll("anchor.y",.5),enemyBullets.setAll("outOfBoundsKill",!0),enemyBullets.setAll("checkWorldBounds",!0),enemyBullets.setAll("lifespan",2e3);var e=this.game.add.bitmapData(4,4);e.ctx.beginPath(),e.ctx.rect(0,0,4,4),e.ctx.fillStyle="#ffff00",e.ctx.fill(),this.emitter=game.add.emitter(0,0,200),this.emitter.makeParticles(e),this.emitter.gravity=0,this.emitter.minParticleSpeed.setTo(-200,-200),this.emitter.maxParticleSpeed.setTo(200,200),cursors=game.input.keyboard.createCursorKeys(),wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),spaceKey=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.game.input.keyboard.addKeyCapture([Phaser.Keyboard.LEFT,Phaser.Keyboard.RIGHT,Phaser.Keyboard.UP,Phaser.Keyboard.DOWN]),player=new Actor(this.game,Game.w/2,Game.h/2,"#0000FF"),player.uid=parseInt(JSON.parse(localStorage.getItem("atPlayer"))),player.fireRate=250,player.nextFire=0,player.health=10,player.bullets=this.game.add.group(),player.bullets.enableBody=!0,player.bullets.physicsBodyType=Phaser.Physics.ARCADE,player.bullets.createMultiple(30,"pbullet",0,!1),player.bullets.setAll("anchor.x",0),player.bullets.setAll("anchor.y",.5),player.bullets.setAll("outOfBoundsKill",!0),player.bullets.setAll("checkWorldBounds",!0),player.movements=function(e){var t={};t.player={};var a={angle:this.angle,x:this.x,y:this.y,health:this.health};if(t.player[this.uid]=a,cursors.up.isDown||wKey.isDown?(this.currentSpeed=300,e.fireRef.set(t)):this.currentSpeed=0,cursors.left.isDown||aKey.isDown?(this.body.angularVelocity=-300,e.fireRef.set(t)):cursors.right.isDown||dKey.isDown?(this.body.angularVelocity=300,e.fireRef.set(t)):this.body.angularVelocity=0,this.game.physics.arcade.velocityFromRotation(this.rotation,this.currentSpeed,this.body.velocity),(this.game.input.activePointer.isDown||spaceKey.isDown)&&1==this.alive&&(e.fireRef.set(t),this.game.time.now>this.nextFire&&this.bullets.countDead()>0)){e.pShotSnd.play(),this.nextFire=this.game.time.now+this.fireRate;var i=this.bullets.getFirstExists(!1);i.lifespan=2e3,i.reset(this.x,this.y),i.rotation=this.rotation,game.physics.arcade.velocityFromRotation(this.rotation,500,i.body.velocity),e.fireRef.set({bullet:{x:this.x,y:this.y,rotation:i.rotation,uid:this.uid,time:this.game.time.now}})}},player.damage=function(e){this.health-=1;var t={};t.player={};var a={angle:this.angle,x:this.x,y:this.y,health:this.health};t.player[this.uid]=a,this.health<=0&&(e.explosionSnd.play(),e.emitter.x=this.x,e.emitter.y=this.y,e.emitter.start(!0,1e3,null,128),this.kill()),e.fireRef.set(t)},actors[player.uid]=player;var t=this;this.fireRef.child("player").on("value",function(e){e.forEach(function(e){var a=e.key(),i=e.val();a!=player.uid&&(void 0===actors[a]?(actors[a]=new Actor(game,i.x,i.y,"#FF0000"),actors[a].health=10):(actors[a].x=i.x,actors[a].y=i.y,actors[a].angle=i.angle,actors[a].health=i.health,actors[a].health<=0&&(t.emitter.x=actors[a].x,t.emitter.y=actors[a].y,t.emitter.start(!0,1e3,null,128),actors[a].kill()),1==i.reset&&actors[a].reset(Game.w/2,Game.h/2)))})}),this.fireRef.child("bullet").on("value",function(e){var t=e.val();if(null!==t&&t.uid!==player.uid){var a=enemyBullets.getFirstDead();a.reset(t.x,t.y),a.rotation=t.rotation,this.game.physics.arcade.velocityFromRotation(a.rotation,500,a.body.velocity)}},function(e){console.log("The read failed: "+e.code)}),this.twitterButton=this.game.add.button(this.game.world.centerX,this.game.world.centerY+200,"twitter",this.twitter,this),this.twitterButton.anchor.set(.5),this.twitterButton.visible=!1,this.playAgainText=this.game.add.bitmapText(Game.w+100,this.game.world.centerY,"minecraftia","",48)},update:function(){var e=this;if(player.alive)this.twitterButton.visible=!1,player.movements(this),Object.keys(actors).forEach(function(e){e!=player.uid&&this.game.physics.arcade.overlap(player.bullets,actors[e],function(e,t){t.kill()},null,this)}),this.game.physics.arcade.overlap(enemyBullets,player,function(t,a){a.kill(),t.damage(e)},null,this);else{this.playAgainText.setText("Play Again?"),this.game.time.events.add(1.5*Phaser.Timer.SECOND,function(){this.game.add.tween(this.playAgainText).to({x:this.game.world.centerX-300},355,Phaser.Easing.Linear.None).start(),this.twitterButton.visible=!0},this);var t={};t.player={},t.player[player.uid]={angle:player.angle,x:player.x,y:player.y,health:0},this.game.time.now>this.deathTimer&&(e.fireRef.set(t),this.deathTimer=this.game.time.now+500),(this.game.input.activePointer.isDown||wKey.isDown||cursors.up.isDown)&&(player.reset(Game.w/2,Game.h/2),player.health=10,e.playAgainText.setText(""),t.player[player.uid]={angle:player.angle,x:player.x,y:player.y,health:0,reset:!0},e.fireRef.set(t))}},makeBox:function(e,t,a){var i=this.game.add.bitmapData(e,t);return i.ctx.beginPath(),i.ctx.rect(0,0,e,t),i.ctx.fillStyle=a,i.ctx.fill(),i},twitter:function(){var e="http://www.divideby5.com/games/spaceduel/",t="rantt_",a=[""];window.open("http://twitter.com/share?text=Come+join+the+multiplayer+mayhem.+at&via="+t+"&url="+e+"&hashtags="+a.join(","),"_blank")}};var game=new Phaser.Game(Game.w,Game.h,Phaser.AUTO,"game");game.state.add("Boot",Game.Boot),game.state.add("Load",Game.Load),game.state.add("Menu",Game.Menu),game.state.add("Play",Game.Play),game.state.start("Boot");