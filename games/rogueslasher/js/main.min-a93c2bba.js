function Automata(t,e){this.width=Math.floor(t),this.height=Math.floor(e),this.lifeCycles=0,this.cells=[],this.minimumLifeCycles=40,this.spawnChance=7,this.resetMap()}function moveActor(t,e){if(!canGo(t,e))return!1;var i=t.ty+e.y+"_"+(t.tx+e.x);if(void 0!=actorMap[i]){var a=actorMap[i];if(a.health--,a===player)for(var s=0;3>s;s++)s<a.health?heartGauge[s].frame=0:heartGauge[s].frame=4;attackSnd.play(),"left"===t.direction?t.animations.play("atk_left"):t.animations.play("atk_right"),a.health<=0&&(score++,t===player&&score++,scoreText.setText("Score: "+score),actorMap[i]=null,actorList[actorList.indexOf(a)]=null,a!==player&&(livingEnemies--,0===livingEnemies&&(level+=1,15>=enemy_count&&enemy_count++,winMsg=this.game.add.bitmapText(Game.w/2,Game.h/2,"minecraftia","Victory!\nPress Space or Click to Continue.",24),winMsg.tint=65280,winMsg.anchor.setTo(.5))),a.kill())}else actorMap[t.ty+"_"+t.tx]=null,t.ty+=e.y,t.tx+=e.x,t.y=t.ty*TILE_SIZE,t.x=t.tx*TILE_SIZE,actorMap[t.ty+"_"+t.tx]=t;return!0}function canGo(t,e){return t.tx+e.x>=0&&t.tx+e.x<=COLS-1&&t.ty+e.y>=0&&t.ty+e.y<=ROWS-1&&map[t.ty+e.y][t.tx+e.x]==FLOOR}function randomInt(t){return Math.floor(Math.random()*t)}function aiAct(t){var e=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}],i=player.tx-t.tx,a=player.ty-t.ty;if(Math.abs(i)+Math.abs(a)>6)for(;!moveActor(t,e[randomInt(e.length)]););Math.abs(i)>Math.abs(a)?0>i?(t.frame=2,t.direction="left",moveActor(t,e[0])):(t.frame=0,t.direction="right",moveActor(t,e[1])):0>a?moveActor(t,e[2]):moveActor(t,e[3]),player.health<1&&(level=0,enemy_count=3,deadSnd.play(),loseMsg=this.game.add.bitmapText(Game.w/2,Game.h/2,"minecraftia","Game Over!\nPress Space or Click to Play Again.",24),loseMsg.tint=16711680,loseMsg.anchor.setTo(.5),twitterButton.visible=!0)}!function(){window.addEventListener("keydown",function(t){[32,37,38,39,40].indexOf(t.keyCode)>-1&&t.preventDefault()},!1)}();var Actor=function(t,e,i,a,s,r){this.game=t,this.tx=e,this.ty=i,this.tile_size=a,Phaser.Sprite.call(this,t,e*a,i*a,s,r),this.game.physics.arcade.enable(this),this.body.collideWorldBounds=!0,this.game.add.existing(this),this.direction="right",this.animations.add("atk_right",[0,1,0],10),this.animations.add("atk_left",[2,3,2],10)};Actor.prototype=Object.create(Phaser.Sprite.prototype),Actor.prototype.constructor=Actor,Automata.prototype.resetMap=function(){this.map=[];for(var t=0;t<this.height;t++){this.map.push([]),this.map[t].push(new Array(this.width));for(var e=0;e<this.width;e++)this.map[t][e]=WALL}},Automata.prototype.print=function(){for(var t="",e=0;e<this.height;e++){for(var i=0;i<this.width;i++){var a="";a=this.map[e][i]===WALL?"#":".",t+=a}t+="\n"}return t},Automata.prototype.csv=function(){for(var t="",e=0;e<this.height;e++){for(var i=0;i<this.width;i++)t+=this.map[e][i],i<this.width-1&&(t+=",");t+="\n"}return t},Automata.prototype.addCell=function(t,e){var i=t||Math.floor(this.width/2),a=e||Math.floor(this.height/2),s=new Cell(i,a,this.map[a][i]);this.map[s.y][s.x]=FLOOR,this.cells.push(s)},Automata.prototype.step=function(){for(var t=0;t<this.cells.length;t++){var e=this.cells[t];if(e.alive){if(this.lifeCycles+=1,this.map=e.cycle(this.map),Math.floor(100*Math.random())<=this.spawnChance&&e.neighbours(this.map).length>0){var i=e.neighbours(this.map)[Math.floor(Math.random()*e.neighbours(this.map).length)];this.addCell(i.x,i.y)}}else{var a=this.cells.indexOf(e);a>-1&&this.cells.splice(a,1)}}},Automata.prototype.generate=function(){for(0===this.cells.length&&this.addCell();this.cells.length>0;)for(var t=0;t<this.cells.length;t++){var e=this.cells[t];if(e.alive){if(this.lifeCycles+=1,this.map=e.cycle(this.map),Math.floor(100*Math.random())<=this.spawnChance&&e.neighbours(this.map).length>0){var i=e.neighbours(this.map)[Math.floor(Math.random()*e.neighbours(this.map).length)];this.addCell(i.x,i.y)}}else{var a=this.cells.indexOf(e);a>-1&&this.cells.splice(a,1)}}this.lifeCycles<this.minimumLifeCycles&&(console.log("reset lifecycle =>"+this.lifeCycles),this.lifeCycles=0,this.resetMap(),this.generate())},Automata.prototype.cleanup=function(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++){var i=new Cell(e,t,this.map[t][e]);i.allowDiagonals=!0,i.neighbours(this.map).length<1&&(this.map[t][e]=FLOOR)}};var Cell=function(t,e,i){this.alive=!0,this.allowDiagonals=!1,this.cycleLimit=30,this.x=t,this.y=e};Cell.prototype={north:function(){var t=this.x,e=this.y-1,i="north";return{x:t,y:e,direction:i}},north_east:function(){var t=this.x+1,e=this.y-1,i="north east";return{x:t,y:e,direction:i}},east:function(){var t=this.x+1,e=this.y,i="east";return{x:t,y:e,direction:i}},south_east:function(){var t=this.x+1,e=this.y+1,i="south east";return{x:t,y:e,direction:i}},south:function(){var t=this.x,e=this.y+1,i="south";return{x:t,y:e,direction:i}},south_west:function(){var t=this.x-1,e=this.y+1,i="south west";return{x:t,y:e,direction:i}},west:function(){var t=this.x-1,e=this.y,i="west";return{x:t,y:e,direction:i}},north_west:function(){var t=this.x-1,e=this.y-1,i="north west";return{x:t,y:e,direction:i}},moveTo:function(t){this.x=t.x,this.y=t.y},cycle:function(t){var e=this.neighbours(t)[Math.floor(Math.random()*this.neighbours(t).length)];return this.alive&&(this.x=e.x,this.y=e.y,t[e.y][e.x]=FLOOR),t}},Cell.prototype.checkNeighbour=function(t,e){var i=e[0].length,a=e.length;try{return t.x<0||t.y<0||t.x>i||t.y>a||e[t.y][t.x]===FLOOR?!1:!0}catch(s){}},Cell.prototype.neighbours=function(t){var e=[];return this.checkNeighbour(this.north(),t)&&e.push(this.north()),this.checkNeighbour(this.east(),t)&&e.push(this.east()),this.checkNeighbour(this.south(),t)&&e.push(this.south()),this.checkNeighbour(this.west(),t)&&e.push(this.west()),this.allowDiagonals===!0&&(this.checkNeighbour(this.south_west(),t)&&e.push(this.south_west()),this.checkNeighbour(this.south_east(),t)&&e.push(this.south_east()),this.checkNeighbour(this.north_east(),t)&&e.push(this.north_east()),this.checkNeighbour(this.north_west(),t)&&e.push(this.north_west())),0===e.length&&(this.alive=!1),e};var ROWS=12,COLS=20,TILE_SIZE=42,Game={w:COLS*TILE_SIZE,h:ROWS*TILE_SIZE};null===localStorage.getItem("atRogueSlasherHighestScore")&&localStorage.setItem("atRogueSlasherHighestScore",0),Game.Boot=function(t){this.game=t},Game.Boot.prototype={preload:function(){this.game.stage.backgroundColor="#454545",this.game.load.image("loading","assets/images/loading.png"),this.game.load.image("title","assets/images/title.png"),this.game.load.image("instructions","assets/images/instructions.png"),this.game.load.bitmapFont("minecraftia","assets/fonts/font.png","assets/fonts/font.xml"),this.game.scale.scaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.scale.maxHeight=window.innerHeight,this.game.scale.maxWidth=window.innerHeight*(Game.w/Game.h)},create:function(){this.game.state.start("Load")}},Game.Load=function(t){this.game=t},Game.Load.prototype={preload:function(){var t=this.game.add.text(Game.w,Game.h,"Loading...",{font:"30px Helvetica",fill:"#000"});t.anchor.setTo(.5,.5);var e=this.game.add.sprite(Game.w/2-64,Game.h/2+50,"loading");this.game.load.setPreloadSprite(e),this.game.load.image("twitter","assets/images/twitter.png"),this.game.load.spritesheet("player","assets/images/player.png",42,42,4),this.game.load.spritesheet("dungeon","assets/images/tiles.png",42,42,7),this.game.load.spritesheet("enemy","assets/images/npc_jack.png",64,64,15),this.game.load.atlasXML("hearts","assets/images/hearts.png","assets/atlas/hearts.xml"),this.game.load.audio("attack","assets/audio/attack.mp3"),this.game.load.audio("dead","assets/audio/dead.mp3"),this.game.load.audio("music","assets/audio/s31-Night_Prowler.mp3")},create:function(){this.game.state.start("Menu")}},Game.Menu=function(t){this.game=t},Game.Menu.prototype={create:function(){this.title=this.game.add.sprite(Game.w/2,Game.h/2-100,"title"),this.title.anchor.setTo(.5,.5),this.instructions=this.game.add.sprite(Game.w/2+200,200,"instructions"),this.instructions.scale.x=.5,this.instructions.scale.y=.5;var t=this.game.add.bitmapText(Game.w/2,Game.h/2+80,"minecraftia","~click to start~",24);if(t.anchor.setTo(.5),this.highestScore=parseInt(JSON.parse(localStorage.getItem("atRogueSlasherHighestScore"))),this.highestScore>0){var e=this.game.add.bitmapText(Game.w/2,Game.h/2+140,"minecraftia","High Score: "+this.highestScore,24);e.tint=16776960,e.anchor.setTo(.5)}},update:function(){this.game.input.activePointer.isDown&&this.game.state.start("Play")}};var wKey,aKey,sKey,dKey,left_key,score=0,scoreText,winMsg,loseMsg,level=0,enemy_count=3,FLOOR,WALL,heartGauge,twitterButton,map,player,actorList,actorMap,livingEnemies,acted;Game.Play=function(t){this.game=t},Game.Play.prototype={create:function(){this.game.world.setBounds(0,0,Game.w,Game.h),this.game.physics.startSystem(Phaser.Physics.ARCADE),this.game.stage.backgroundColor="#000",this.highestScore=parseInt(JSON.parse(localStorage.getItem("atRogueSlasherHighestScore"))),attackSnd=this.game.add.sound("attack"),deadSnd=this.game.add.sound("dead"),this.music=this.game.add.sound("music"),this.music.play("",0,.3,!0),this.cursors=this.game.input.keyboard.createCursorKeys(),wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),spaceKey=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.movement={up:function(){acted=moveActor(player,{x:0,y:-1})},down:function(){acted=moveActor(player,{x:0,y:1})},left:function(){player.frame=2,player.direction="left",acted=moveActor(player,{x:-1,y:0})},right:function(){player.direction="right",player.frame=0,acted=moveActor(player,{x:1,y:0})}},this.cursors.up.onUp.add(this.onKeyUp,this),wKey.onUp.add(this.onKeyUp,this),this.cursors.down.onUp.add(this.onKeyUp,this),sKey.onUp.add(this.onKeyUp,this),this.cursors.left.onUp.add(this.onKeyUp,this),aKey.onUp.add(this.onKeyUp,this),this.cursors.right.onUp.add(this.onKeyUp,this),dKey.onUp.add(this.onKeyUp,this),spaceKey.onUp.add(this.resetGame,this),this.game.input.onUp.add(this.resetGame,this),this.loadLevel(),this.loadActors()},loadTouchControls:function(){var t=80;this.arrowbmd=this.game.add.bitmapData(t,t),this.arrowbmd.ctx.clearRect(0,0,t,t),this.arrowbmd.ctx.strokeStyle="white",this.arrowbmd.ctx.lineWidth=2,this.arrowbmd.ctx.fill(),this.arrowbmd.ctx.beginPath(),this.arrowbmd.ctx.moveTo(1*t/2,0),this.arrowbmd.ctx.lineTo(0,1*t/2),this.arrowbmd.ctx.lineTo(1*t/4,1*t/2),this.arrowbmd.ctx.lineTo(1*t/4,t),this.arrowbmd.ctx.lineTo(3*t/4,t),this.arrowbmd.ctx.lineTo(3*t/4,1*t/2),this.arrowbmd.ctx.lineTo(t,1*t/2),this.arrowbmd.ctx.fill(),this.upArrow=this.game.add.sprite(140,Game.h-160,this.arrowbmd),this.upArrow.tint=14474460,this.upArrow.alpha=.5,this.upArrow.anchor.setTo(.5,.5),this.upArrow.inputEnabled=!0,this.upArrow.events.onInputUp.add(this.onKeyUp,this),this.upArrow.visible=!1,this.downArrow=this.game.add.sprite(140,Game.h-40,this.arrowbmd),this.downArrow.tint=14474460,this.downArrow.alpha=.5,this.downArrow.anchor.setTo(.5,.5),this.downArrow.inputEnabled=!0,this.downArrow.angle=180,this.downArrow.events.onInputUp.add(this.onKeyUp,this),this.downArrow.visible=!1,this.leftArrow=this.game.add.sprite(60,Game.h-100,this.arrowbmd),this.leftArrow.tint=14474460,this.leftArrow.alpha=.5,this.leftArrow.anchor.setTo(.5,.5),this.leftArrow.inputEnabled=!0,this.leftArrow.angle=-90,this.leftArrow.events.onInputUp.add(this.onKeyUp,this),this.leftArrow.visible=!1,this.rightArrow=this.game.add.sprite(220,Game.h-100,this.arrowbmd),this.rightArrow.tint=14474460,this.rightArrow.alpha=.5,this.rightArrow.anchor.setTo(.5,.5),this.rightArrow.inputEnabled=!0,this.rightArrow.angle=90,this.rightArrow.events.onInputUp.add(this.onKeyUp,this),this.rightArrow.visible=!1,/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?(this.upArrow.visible=!0,this.downArrow.visible=!0,this.leftArrow.visible=!0,this.rightArrow.visible=!0):(this.upArrow.visible=!1,this.downArrow.visible=!1,this.leftArrow.visible=!1,this.rightArrow.visible=!1)},resetGame:function(){0===livingEnemies?(this.loadLevel(),this.loadActors()):player.alive||(score=0,this.loadLevel(),this.loadActors())},onKeyUp:function(t){if(player.alive!==!1&&(acted=!1,t===this.cursors.up||t===wKey||t===this.upArrow?this.movement.up():t===this.cursors.down||t===sKey||t===this.downArrow?this.movement.down():t===this.cursors.left||t===aKey||t===this.leftArrow?this.movement.left():(t===this.cursors.right||t===dKey||t===this.rightArrow)&&this.movement.right(),acted))for(var e in actorList)if(0!=e){var i=actorList[e];null!=i&&aiAct(i)}},loadActors:function(){function t(t){return Math.floor(Math.random()*t)}actorList=[],actorMap={};for(var e=0;enemy_count>e;e++){var i;0===e?(i=new Actor(this.game,0,0,TILE_SIZE,"player",0),i.health=3):(i=new Actor(this.game,0,0,TILE_SIZE,"player",0),i.tint=16711680,i.health=1);do i.ty=t(ROWS),i.tx=t(COLS),i.y=i.ty*TILE_SIZE,i.x=i.tx*TILE_SIZE;while(map[i.ty][i.tx]==WALL||null!=actorMap[i.ty+"_"+i.tx]);actorMap[i.ty+"_"+i.tx]=i,actorList.push(i),livingEnemies=enemy_count-1}player=actorList[0],this.game.camera.follow(player,Phaser.Camera.FOLLOW_PLATFORMER)},loadLevel:function(){2>level?(FLOOR="6",WALL="5"):4>level?(FLOOR="6",WALL="2"):6>level?(FLOOR="2",WALL="5"):8>level?(FLOOR="2",WALL="4"):10>level?(FLOOR="1",WALL="2"):(FLOOR="1",WALL="3"),this.auto=new Automata(COLS,ROWS),this.auto.generate(),this.auto.cleanup();var t=this.auto.csv();map=this.auto.map,this.game.load.tilemap("level",null,t,Phaser.Tilemap.CSV),this.map=this.game.add.tilemap("level",TILE_SIZE,TILE_SIZE),this.map.addTilesetImage("dungeon"),this.layer=this.map.createLayer(0),this.map.setCollision(0),this.layer.resizeWorld(),heartGauge=[this.game.add.sprite(20,15,"hearts"),this.game.add.sprite(60,15,"hearts"),this.game.add.sprite(100,15,"hearts")],scoreText=this.game.add.bitmapText(Game.w-120,48,"minecraftia","Score: "+score,32),scoreText.anchor.setTo(.5,.5),this.loadTouchControls(),twitterButton=this.game.add.button(this.game.world.centerX,this.game.world.centerY+100,"twitter",this.twitter,this),twitterButton.anchor.set(.5),twitterButton.visible=!1},update:function(){this.game.physics.arcade.collide(player,this.layer),score>this.highestScore&&(this.highestScore=score,localStorage.setItem("atRogueSlasherHighestScore",score))},twitter:function(){var t="http://www.divideby5.com/games/rogueslasher/",e="rantt_",i=["onegameaweek"];window.open("http://twitter.com/share?text=My+best+score+is+"+this.highestScore+"+playing+ROGUE+SLASHER+See+if+you+can+beat+it.+at&via="+e+"&url="+t+"&hashtags="+i.join(","),"_blank")}};var game=new Phaser.Game(Game.w,Game.h,Phaser.AUTO,"game");game.state.add("Boot",Game.Boot),game.state.add("Load",Game.Load),game.state.add("Menu",Game.Menu),game.state.add("Play",Game.Play),game.state.start("Boot");