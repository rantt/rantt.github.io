function Automata(t,e){this.width=t,this.height=e,this.lifeCycles=0,this.cells=[],this.minimumLifeCycles=100,this.spawnChance=6,this.resetMap()}var FILLED="44",EMPTY="20";Automata.prototype.resetMap=function(){this.map=[];for(var t=0;t<this.height;t++){this.map.push([]),this.map[t].push(new Array(this.width));for(var e=0;e<this.width;e++)this.map[t][e]=FILLED}},Automata.prototype.print=function(){for(var t="",e=0;e<this.height;e++){for(var i=0;i<this.width;i++){var s="";s=this.map[e][i]===FILLED?"#":".",t+=s}t+="\n"}return t},Automata.prototype.csv=function(){for(var t="",e=0;e<this.height;e++){for(var i=0;i<this.width;i++)t+=this.map[e][i],i<this.width-1&&(t+=",");t+="\n"}return t},Automata.prototype.addCell=function(t,e){var i=t||Math.floor(this.width/2),s=e||Math.floor(this.height/2),a=new Cell(i,s,this.map[s][i]);this.map[a.y][a.x]=EMPTY,this.cells.push(a)},Automata.prototype.step=function(){for(var t=0;t<this.cells.length;t++){var e=this.cells[t];if(e.alive){if(this.lifeCycles+=1,this.map=e.cycle(this.map),Math.floor(100*Math.random())<=this.spawnChance&&e.neighbours(this.map).length>0){var i=e.neighbours(this.map)[Math.floor(Math.random()*e.neighbours(this.map).length)];this.addCell(i.x,i.y)}}else{var s=this.cells.indexOf(e);s>-1&&this.cells.splice(s,1)}}},Automata.prototype.generate=function(){for(0===this.cells.length&&this.addCell();this.cells.length>0;)for(var t=0;t<this.cells.length;t++){var e=this.cells[t];if(e.alive){if(this.lifeCycles+=1,this.map=e.cycle(this.map),Math.floor(100*Math.random())<=this.spawnChance&&e.neighbours(this.map).length>0){var i=e.neighbours(this.map)[Math.floor(Math.random()*e.neighbours(this.map).length)];this.addCell(i.x,i.y)}}else{var s=this.cells.indexOf(e);s>-1&&this.cells.splice(s,1)}}this.lifeCycles<this.minimumLifeCycles?(console.log("reset lifecycle =>"+this.lifeCycles),this.lifeCycles=0,this.resetMap(),this.generate()):console.log("normal lifecycle =>"+this.lifeCycles)},Automata.prototype.cleanup=function(){for(var t=0;t<this.height;t++)for(var e=0;e<this.width;e++){var i=new Cell(e,t,this.map[t][e]);i.allowDiagonals=!0,i.neighbours(this.map).length<1&&(this.map[t][e]=EMPTY)}};var Cell=function(t,e,i){this.alive=!0,this.allowDiagonals=!1,this.cycleLimit=30,this.x=t,this.y=e};Cell.prototype={north:function(){var t=this.x,e=this.y-1,i="north";return{x:t,y:e,direction:i}},north_east:function(){var t=this.x+1,e=this.y-1,i="north east";return{x:t,y:e,direction:i}},east:function(){var t=this.x+1,e=this.y,i="east";return{x:t,y:e,direction:i}},south_east:function(){var t=this.x+1,e=this.y+1,i="south east";return{x:t,y:e,direction:i}},south:function(){var t=this.x,e=this.y+1,i="south";return{x:t,y:e,direction:i}},south_west:function(){var t=this.x-1,e=this.y+1,i="south west";return{x:t,y:e,direction:i}},west:function(){var t=this.x-1,e=this.y,i="west";return{x:t,y:e,direction:i}},north_west:function(){var t=this.x-1,e=this.y-1,i="north west";return{x:t,y:e,direction:i}},moveTo:function(t){this.x=t.x,this.y=t.y},cycle:function(t){var e=this.neighbours(t)[Math.floor(Math.random()*this.neighbours(t).length)];return this.alive&&(this.x=e.x,this.y=e.y,t[e.y][e.x]=EMPTY),t}},Cell.prototype.checkNeighbour=function(t,e){var i=e[0].length,s=e.length;try{return t.x<0||t.y<0||t.x>i||t.y>s||e[t.y][t.x]===EMPTY?!1:!0}catch(a){}},Cell.prototype.neighbours=function(t){var e=[];return this.checkNeighbour(this.north(),t)&&e.push(this.north()),this.checkNeighbour(this.east(),t)&&e.push(this.east()),this.checkNeighbour(this.south(),t)&&e.push(this.south()),this.checkNeighbour(this.west(),t)&&e.push(this.west()),this.allowDiagonals===!0&&(this.checkNeighbour(this.south_west(),t)&&e.push(this.south_west()),this.checkNeighbour(this.south_east(),t)&&e.push(this.south_east()),this.checkNeighbour(this.north_east(),t)&&e.push(this.north_east()),this.checkNeighbour(this.north_west(),t)&&e.push(this.north_west())),0===e.length&&(this.alive=!1),e};var Game={w:1024,h:768},TILE_SIZE=8;Game.Boot=function(t){this.game=t},Game.Boot.prototype={preload:function(){this.game.stage.backgroundColor="#FFF",this.game.load.image("loading","assets/images/loading.png"),this.game.load.image("title","assets/images/title.png"),this.game.load.image("instructions","assets/images/instructions.png")},create:function(){this.game.state.start("Load")}},Game.Load=function(t){this.game=t},Game.Load.prototype={preload:function(){var t=this.game.add.text(Game.w,Game.h,"Loading...",{font:"30px Helvetica",fill:"#000"});t.anchor.setTo(.5,.5);var e=this.game.add.sprite(Game.w/2-64,Game.h/2+50,"loading");this.game.load.setPreloadSprite(e),this.game.load.spritesheet("cave","assets/images/caves.png",20,20,4)},create:function(){this.game.state.start("Menu")}},Game.Menu=function(t){this.game=t},Game.Menu.prototype={create:function(){this.title=this.game.add.sprite(Game.w/2,Game.h/2-100,"title"),this.title.anchor.setTo(.5,.5),this.instructions=this.game.add.sprite(Game.w/2+200,200,"instructions"),this.instructions.scale.x=.5,this.instructions.scale.y=.5;var t=this.game.add.text(Game.w/2,Game.h/2-50,"~click to start~",{font:"30px Helvetica",fill:"#000"});t.anchor.setTo(.5,.5)},update:function(){this.game.input.activePointer.isDown&&this.game.state.start("Play")}};var wKey,aKey,sKey,dKey,pointer;Game.Play=function(t){this.game=t},Game.Play.prototype={create:function(){this.game.world.setBounds(0,0,Game.w,Game.h),this.game.physics.startSystem(Phaser.Physics.P2JS),this.game.stage.backgroundColor="#ececec",this.bmdTiles=this.genTileset(TILE_SIZE,TILE_SIZE),this.generateCave(),this.waitTime=this.game.time.now,wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),this.game.input.onUp.add(this.upPointer,this)},generateCave:function(){this.auto=new Automata(Game.w/TILE_SIZE,Game.h/TILE_SIZE),this.auto.generate(),this.auto.cleanup();var t=this.auto.csv();this.game.load.tilemap("level",null,t,Phaser.Tilemap.CSV),this.map=this.game.add.tilemap("level",TILE_SIZE,TILE_SIZE),this.map.addTilesetImage("tiles",this.bmdTiles),this.layer=this.map.createLayer(0),this.map.setCollision(0),this.map.setCollision(1),this.layer.resizeWorld(),this.physics.p2.convertTilemap(this.map,this.layer)},genTileset:function(t,e){bmd=this.game.make.bitmapData(25*t,2*e);for(var i=Phaser.Color.HSVColorWheel(),s=0,a=0;2>a;a++)for(var h=0;25>h;h++)bmd.rect(h*t,a*e,t,e,i[s].rgba),s+=6;return bmd},upPointer:function(){this.layer&&this.layer.destroy(),this.generateCave()},setupNewCave:function(){this.auto=new Automata(Game.w/TILE_SIZE,Game.h/TILE_SIZE),this.auto.addCell()},stepCave:function(){this.auto.step();var t=this.auto.csv();this.game.load.tilemap("level",null,t,Phaser.Tilemap.CSV),this.map=this.game.add.tilemap("level",TILE_SIZE,TILE_SIZE),this.map.addTilesetImage("tiles",this.bmdTiles),this.layer=this.map.createLayer(0)},update:function(){}};var game=new Phaser.Game(Game.w,Game.h,Phaser.AUTO,"game");game.state.add("Boot",Game.Boot),game.state.add("Load",Game.Load),game.state.add("Menu",Game.Menu),game.state.add("Play",Game.Play),game.state.start("Boot");
