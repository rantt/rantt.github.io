function rand(e,t){return Math.floor(Math.random()*(t-e+1))+e}function lineDistance(e,t){var i=0,s=0;return i=Math.abs(e.x-t.x),i*=i,s=Math.abs(e.y-t.y),s*=s,Math.sqrt(i+s)}function lineDistance(e,t){var i=0,s=0;return i=Math.abs(e.x-t.x),i*=i,s=Math.abs(e.y-t.y),s*=s,Math.sqrt(i+s)}var wKey,aKey,sKey,dKey,Player=function(e){this.game=e,this.sprite=null,this.alive=!0,this.tilex=0,this.tiley=0};Player.prototype={preload:function(){this.game.load.spritesheet("player","assets/images/hero_x64.png",64,64,12)},create:function(){this.cursor=this.game.input.keyboard.createCursorKeys(),wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),this.sprite=this.game.add.sprite(this.tilex*tileSize-tileSize/2,this.tiley*tileSize+tileSize/2,"player"),this.sprite.anchor.setTo(.5,.5),this.game.physics.p2.enable(this.sprite),this.sprite.body.fixedRotation=!0,this.sprite.body.clearShapes(),this.sprite.body.addRectangle(16,32,0,16),this.sprite.direction="down",this.sprite.animations.add("down",[6,7],6,!0),this.sprite.animations.add("up",[8,9],6,!0),this.sprite.animations.add("right",[4,11],6,!0),this.sprite.animations.add("left",[5,10],6,!0)},update:function(){this.movements(),this.updatecamera()},updatecamera:function(){if(!this.tweening){this.tweening=!0;var e=700,t=!1;if(this.sprite.y>this.game.camera.y+Game.h?(Game.camera.y+=1,t=!0):this.sprite.y<this.game.camera.y?(Game.camera.y-=1,t=!0):this.sprite.x>this.game.camera.x+Game.w?(Game.camera.x+=1,t=!0):this.sprite.x<this.game.camera.x&&(Game.camera.x-=1,t=!0),t){var i=this.game.add.tween(this.game.camera).to({x:Game.camera.x*Game.w,y:Game.camera.y*Game.h},e);i.start(),i.onComplete.add(function(){this.tweening=!1},this)}else this.tweening=!1}},reposition:function(){this.sprite.x=this.tilex*tileSize-tileSize/2,this.sprite.y=this.tiley*tileSize+tileSize/2},movements:function(){this.sprite.body.velocity.x=0,this.sprite.body.velocity.y=0;var e=275;this.tweening?(this.sprite.body.velocity.x=0,this.sprite.body.velocity.y=0):dialogue.hidden&&(this.cursor.left.isDown||aKey.isDown)?(this.sprite.body.velocity.x=-e,this.sprite.direction="left",this.sprite.animations.play("left")):dialogue.hidden&&(this.cursor.right.isDown||dKey.isDown)?(this.sprite.body.velocity.x=e,this.sprite.direction="right",this.sprite.animations.play("right")):dialogue.hidden&&(this.cursor.up.isDown||wKey.isDown)?(this.sprite.body.velocity.y=-e,this.sprite.direction="up",this.sprite.animations.play("up")):dialogue.hidden&&(this.cursor.down.isDown||sKey.isDown)?(this.sprite.body.velocity.y=e,this.sprite.direction="down",this.sprite.animations.play("down")):("up"===this.sprite.direction?this.sprite.frame=1:"down"===this.sprite.direction?this.sprite.frame=0:"right"===this.sprite.direction?this.sprite.frame=2:"left"===this.sprite.direction&&(this.sprite.frame=3),this.sprite.animations.stop())}};for(var map=[],dFloor=3,dRows=42,dCols=30,i=0;dRows>i;i++){map[i]=[];for(var j=0;dCols>j;j++)map[i][j]=0}var Room=function(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s,this.top=this.y,this.bottom=this.y+this.height-1,this.left=this.x,this.right=this.x+this.width-1,this.center={x:~~(this.x+this.width/2),y:~~(this.y+this.height/2)},this.topLeft={x:this.top,y:this.left},this.topCenter={x:this.center.x,y:this.top},this.topRight={x:this.right,y:this.top},this.leftCenter={x:this.left,y:this.center.y},this.rightCenter={x:this.right,y:this.center.y},this.bottomLeft={x:this.x,y:this.bottom},this.bottomCenter={x:this.center.x,y:this.bottom},this.bottomRight={x:this.right,y:this.bottom}};Room.prototype={draw:function(){for(var e=this.y;e<this.y+this.height;e++)for(var t=this.x;t<this.x+this.width;t++)map[e][t]=dFloor}};var Knode=function(e,t,i,s){this.minLeafSize=6,this.x=e,this.y=t,this.width=i,this.height=s,this.leftChild=null,this.rightChild=null,this.room=null};Knode.prototype={split:function(){if(null!==this.leftChild||null!==this.rightChild)return!1;var e=rand(1,10)>5;this.width>this.height&&this.height/this.width>.5?e=!1:this.height>this.width&&this.width/this.height>=.05&&(e=!0);var t=(e?this.height:this.width)-this.minLeafSize;if(t<=this.minLeafSize)return!1;var i=rand(this.minLeafSize,t);return e?(this.leftChild=new Knode(this.x,this.y,this.width,i),this.rightChild=new Knode(this.x,this.y+i,this.width,this.height-i)):(this.leftChild=new Knode(this.x,this.y,i,this.height),this.rightChild=new Knode(this.x+i,this.y,this.width-i,this.height)),!0},createRooms:function(){if(null!==this.leftChild||null!==this.rightChild){if(null!==this.leftChild&&this.leftChild.createRooms(),null!==this.rightChild&&this.rightChild.createRooms(),null!==this.leftChild&&null!==this.rightChild)for(var e=this.createHall(this.leftChild.getRoom(),this.rightChild.getRoom()),t=0;t<e.length;t++)map[e[t].y][e[t].x]=dFloor}else{var i=rand(3,this.width),s=rand(3,this.height),a=rand(this.x+1,this.x+this.width-i-1),h=rand(this.y+1,this.y+this.height-s-1);this.room=new Room(a,h,i,s),this.room.draw()}},createHall:function(e,t){for(var i=[],s=10,a={x:~~(Math.random()*e.width)+e.x,y:~~(Math.random()*e.height)+e.y},h={x:~~(Math.random()*t.width)+t.x,y:~~(Math.random()*t.height)+t.y};h.x!==a.x||h.y!==a.y;){var o=100*Math.random();s>o?h.x!==a.x&&(h.x>a.x?h.x--:h.x++):h.y!==a.y&&(h.y>a.y?h.y--:h.y++),h.x<42&&h.y<30&&i.push({x:h.x,y:h.y})}return i},getRoom:function(){if(null!==this.room)return this.room;var e,t;return null!==this.leftChild&&(e=this.leftChild.getRoom()),null!==this.rightChild&&(t=this.rightChild.getRoom()),null===e&&null===t?null:null===t?e:null===e?t:Math.random()>.5?e:t}};var Maze=function(e,t){this.dRows=t,this.dCols=e,this.roomMin=3,this.roomMax=9};Maze.prototype={create:function(){this.root=new Knode(0,0,this.dCols,this.dRows),this.nodes=this.traverse(this.root,[]),this.root.createRooms()},traverse:function(e,t){var i=10;return null===e.leftChild&&null===e.rightChild&&(e.width>i||e.height>i)&&e.split()?this.traverse(e.leftChild,t)&&this.traverse(e.rightChild,t):(t.push(e),t)},drawLevel:function(){for(var e,t="",i=0,s=0,a=0;a<this.dRows;a++){e=[];for(var h=0;h<this.dCols;h++)0===map[a][h]||void 0===map[a][h]?(i=a>0?map[a-1][h]:0,s=map[a+1][h]||0,3===s?e[h]=2:3===i?a>2&&(e[h]=3===map[a+2][h]?1:2):e[h]=0):e[h]=map[a][h];t+=e.join(",")+"\n"}return t}};var Npc=function(e,t,i,s,a,h,o){Phaser.Sprite.call(this,e,t-32,i-32,s),this.anchor.setTo(.5,.5),this.frame=parseInt(a),this.startFrame=a,this.facing="undefined"!=typeof o?o:!0,this.game.physics.p2.enable(this),this.body.kinematic=!0,this.LEFT=9,this.RIGHT=6,this.UP=3,this.DOWN=0,this.script=h.split("*"),this.spoke=!1};Npc.prototype=Object.create(Phaser.Sprite.prototype),Npc.prototype.interact=function(){if(lineDistance(player.sprite,this)<72){var e=this.y-player.sprite.y,t=this.x-player.sprite.x;return this.facing===!0&&(this.frame=Math.abs(t)>Math.abs(e)?t>0?this.LEFT:this.RIGHT:e>0?this.UP:this.DOWN),this.spoke===!1?(dialogue.show(this,this.script),this.spoke=!0):dialogue.show(this,new Array("",this.script[this.script.length-1])),!0}return this.frame=this.startFrame,!1},Npc.prototype.constructor=Npc;var Dialogue=function(e){this.game=e,this.hidden=!0,this.sprite=null,this.index=0,this.line="",this.text="",this.typing=!1,this.speaker=null};Dialogue.prototype={preload:function(){this.game.load.image("textbox","assets/images/textbox.png",tileSize,tileSize)},create:function(){this.sprite=this.game.add.sprite(0,704,"textbox"),this.sprite.alpha=0,this.text=this.game.add.bitmapText(30,478,"minecraftia","",30)},show:function(e,t){if(!this.typing){this.speaker=e,this.content=t,this.typing=!0,this.hidden=!1,this.sprite.x=Game.camera.x*Game.w,this.sprite.y=Game.camera.y*Game.h+704,this.text.x=Game.camera.x*Game.w+30,this.text.y=Game.camera.y*Game.h+448+30,this.sprite.alpha=100;var i=this.game.add.tween(this.sprite).to({x:Game.camera.x*Game.w,y:Game.camera.y*Game.h+448},250);i.start(),i.onComplete.add(function(){this.nextLine()},this)}},hide:function(){if(this.hidden!==!0){this.text.setText(""),this.line="",this.index=0;var e=this.game.add.tween(this.sprite).to({x:Game.camera.x*Game.w,y:Game.camera.y*Game.h+704},250);e.start(),e.onComplete.add(function(){this.hidden=!0,this.sprite.alpha=0},this)}},nextLine:function(){this.index++,this.index<this.content.length?(this.line="",this.game.time.events.repeat(80,this.content[this.index].length+1,this.updateLine,this)):(this.typing=!1,this.speaker=null,this.text.setText(this.line+" *"))},updateLine:function(){this.line.length<this.content[this.index].length?(this.line=this.content[this.index].substr(0,this.line.length+1),this.text.setText(this.line)):this.game.time.events.add(Phaser.Timer.SECOND,this.nextLine,this)}};var tileSize=64,dRows=10,dCols=12,player,dialogue,spaceKey,Game={w:tileSize*dCols,h:tileSize*dRows,lastLocation:"MyHouse",scene:1,camera:{x:0,y:0}};null===localStorage.getItem("scene")&&localStorage.setItem("scene","1"),null===localStorage.getItem("haveRope")&&localStorage.setItem("haveRope",!1),null===localStorage.getItem("haveLamp")&&localStorage.setItem("haveLamp",!1),Game.Boot=function(e){this.game=e},Game.Boot.prototype={preload:function(){this.game.stage.backgroundColor="#000",this.game.load.image("loading","assets/images/loading.png"),this.game.load.image("title","assets/images/title.png"),this.game.load.image("instructions","assets/images/instructions.png"),this.game.load.bitmapFont("minecraftia","assets/fonts/font.png","assets/fonts/font.xml")},create:function(){this.game.state.start("Load")}},Game.Load=function(e){this.game=e},Game.Load.prototype={preload:function(){var e=this.game.add.sprite(Game.w/2-64,Game.h/2+50,"loading");this.game.load.setPreloadSprite(e),this.game.load.tilemap("town","assets/maps/town.json",null,Phaser.Tilemap.TILED_JSON),this.game.load.spritesheet("town","assets/images/town.png",tileSize,tileSize,36),this.game.load.tilemap("myhouse","assets/maps/myhouse.json",null,Phaser.Tilemap.TILED_JSON),this.game.load.tilemap("gramps","assets/maps/gramps.json",null,Phaser.Tilemap.TILED_JSON),this.game.load.spritesheet("furniture","assets/images/furniture.png",tileSize,tileSize,20),this.game.load.spritesheet("house","assets/images/house.png",tileSize,tileSize,20),this.game.load.image("textbox","assets/images/textbox.png",tileSize,tileSize),this.game.load.spritesheet("dad","assets/images/npc_dad.png",64,64,12),this.game.load.spritesheet("mom","assets/images/npc_mom.png",64,64,12),this.game.load.spritesheet("jack","assets/images/npc_jack.png",64,64,15),this.game.load.spritesheet("gramps","assets/images/npc_gramps.png",64,64,12),this.game.load.spritesheet("clara","assets/images/npc_clara.png",64,64,15),this.game.load.image("twitter","assets/images/twitter.png"),this.game.load.audio("music","assets/audio/a_theme.mp3"),this.game.load.audio("tomb","assets/audio/forgotten_tombs.mp3"),dialogue=new Dialogue(this.game),dialogue.preload(),player=new Player(this.game),player.preload(),spaceKey=this.game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR)},create:function(){this.game.state.start("Menu")}},Game.Menu=function(e){this.game=e},Game.Menu.prototype={create:function(){this.title=this.game.add.sprite(Game.w/2,Game.h/2-100,"title"),this.title.anchor.setTo(.5,.5),this.instructions=this.game.add.sprite(Game.w/2-100,400,"instructions"),this.instructions.scale.x=.5,this.instructions.scale.y=.5},update:function(){this.game.input.activePointer.isDown&&(this.game.state.start("Town"),Game.music=this.game.add.sound("music"),Game.music.volume=.5,Game.music.play("",0,1,!0))}},Game.Town=function(e){this.game=e},Game.Town.prototype={preload:function(){this.scene=parseInt(localStorage.getItem("scene")),this.haveRope=JSON.parse(localStorage.getItem("haveRope")),this.haveLamp=JSON.parse(localStorage.getItem("haveLamp"))},create:function(){this.game.physics.startSystem(Phaser.Physics.P2JS),this.game.physics.p2.setBoundsToWorld(!0,!0,!0,!0,!1),this.game.world.setBounds(0,0,Game.w,Game.h),this.map=this.game.add.tilemap("town"),this.map.addTilesetImage("town"),this.layer1=this.map.createLayer("layer1"),this.layer1.resizeWorld(),this.layer2=this.map.createLayer("layer2"),this.layer2.resizeWorld(),this.map.setCollision([13,14,15]),this.map.setCollision([16,17,18],!0,"layer2"),this.map.setCollision(21),this.map.setCollision(22),this.map.setCollision(23),this.map.setCollision(24),this.map.setCollision(25),this.map.setCollision(26),this.map.setCollision(27),this.map.setCollision(32),this.map.setCollision(52),this.map.setCollision(30),this.map.setCollision(34,!0,"layer2"),this.map.setCollision(33,!0,"layer2"),this.npcs=this.game.add.group(),this.lines={mom:{1:"*Hi honey.*Beautiful day, isn't it?",2:"*You wanna play with Jack?*Oh, ok.  Have fun.*Be home for dinner.",3:"*There might be some in the house.*Why don't you ask your father.",4:"*There might be some in the house.*Why don't you ask your father."},jack:{1:"*Hey, wanna play?*Let's go to the old well.*Better ask your mom first.",2:"*We should go down there.*We'll need some stuff though.*Go get some rope and a light.",3:"*We should go down there?*We'll need some stuff though.*Go get some rope and a light.",4:"*Oh, good you got everything!*What are we waiting for?, Let's go!",7:"*I guess you needed this.*See you around..."},clara:{1:"*Hi, nice day for skipping!",2:"*Hey, wanna play?*Jack huh? You always play with him.*Nevermind then!",3:"*Rope?*I have skipping rope. Will that work?",4:"*Rope?*I have skipping rope. Will that work?"}},this.physics.p2.convertTilemap(this.map,this.layer1),this.physics.p2.convertTilemap(this.map,this.layer2),this.haveRope&&this.haveLamp&&7!==this.scene&&(this.scene=4,localStorage.setItem("scene","4")),this.jack=1===this.scene||7===this.scene?new Npc(this.game,10*tileSize,7*tileSize,"jack",9,this.lines.jack[this.scene]):new Npc(this.game,5*tileSize,15*tileSize,"jack",9,this.lines.jack[this.scene]),7!==this.scene&&(this.npcs.add(new Npc(this.game,9*tileSize,3*tileSize,"mom",0,this.lines.mom[this.scene])),this.clara=new Npc(this.game,16*tileSize,6*tileSize,"clara",0,this.lines.clara[this.scene]),this.clara.animations.add("skipping",[12,13,14],6,!0),this.clara.animations.play("skipping"),this.npcs.add(this.clara)),this.jack.animations.add("right",[7,8],6,!0),this.npcs.add(this.jack),this.exitPoints=this.game.add.group(),this.map.createFromObjects("objects",29,"town",28,!0,!1,this.exitPoints),this.map.createFromObjects("objects",30,"town",29,!0,!1,this.exitPoints),this.map.createFromObjects("objects",34,"town",33,!0,!1,this.exitPoints),"MyHouse"===Game.lastLocation?(Game.camera={x:0,y:0},player.tilex=5,player.tiley=6,Game.lastLocation="Town"):"Gramps"===Game.lastLocation&&(Game.camera={x:1,y:1},this.game.camera.x=Game.camera.x*Game.w,this.game.camera.y=Game.camera.y*Game.h,player.tilex=20,player.tiley=17,Game.lastLocation="Town"),player.create(),dialogue.create()},updateCharacterLines:function(){this.updating||(this.updating=!0,this.npcs.forEach(function(e){e.script=this.lines[e.key][this.scene].split("*"),e.spoke=!1},this),this.updating=!1)},jackLeaves:function(e){if(!this.tweening){this.tweening=!0,this.jack.animations.play("right");var t=this.game.add.tween(this.jack.body).to({x:this.jack.body.x+256},1e3);t.start(),t.onComplete.add(function(){this.scene=e,localStorage.setItem("scene","2"),this.tweening=!1,this.jack.body.x=5*tileSize-32,this.jack.body.y=15*tileSize-32,this.jack.frame=9,this.jack.animations.stop(),this.updateCharacterLines()},this)}},update:function(){this.jack.spoke===!0&&!dialogue.typing&&dialogue.hidden&&1===this.scene&&this.jackLeaves(2),this.jack.spoke===!0&&!dialogue.typing&&dialogue.hidden&&2===this.scene&&(this.scene=3,localStorage.setItem("scene","3"),this.updateCharacterLines()),7!==this.scene?dialogue.speaker===this.clara?this.clara.animations.stop():"skipping"!==this.clara.animations.currentAnim&&this.clara.play("skipping"):this.jack.spoke===!0&&!dialogue.typing&&dialogue.hidden&&this.jackLeaves(7),this.exitPoints.forEach(function(e){var t=e.getBounds(),i=player.sprite.getBounds();Phaser.Rectangle.intersects(t,i)&&("Darkness"!==e.destination||"Darkness"===e.destination&&this.haveLamp===!0&&this.haveRope===!0)&&this.game.state.start(e.destination)},this),spaceKey.isDown&&dialogue.hidden&&this.npcs.forEach(function(e){e.interact()},this),!spaceKey.isDown||dialogue.typing||dialogue.hidden||dialogue.hide(),player.update()}},Game.MyHouse=function(e){this.game=e},Game.MyHouse.prototype={create:function(){this.game.physics.startSystem(Phaser.Physics.P2JS),this.scene=parseInt(localStorage.getItem("scene")),this.haveRope=JSON.parse(localStorage.getItem("haveRope")),this.haveLamp=JSON.parse(localStorage.getItem("haveLamp")),this.game.physics.p2.setBoundsToWorld(!0,!0,!0,!0,!1),Game.camera={x:0,y:1},this.game.camera.x=Game.camera.x*Game.w,this.game.camera.y=Game.camera.y*Game.h,this.game.world.setBounds(0,0,Game.w,Game.h),this.map=this.game.add.tilemap("myhouse"),this.map.addTilesetImage("house"),this.map.addTilesetImage("furniture"),this.layer1=this.map.createLayer("layer1"),this.layer1.resizeWorld(),this.layer2=this.map.createLayer("layer2"),this.layer2.resizeWorld(),this.map.setCollision(2),this.map.setCollision(12),this.map.setCollision(13),this.map.setCollision(38,!0,"layer2"),this.map.setCollision(39,!0,"layer2"),this.map.setCollision(40,!0,"layer2"),this.map.setCollision(41,!0,"layer2"),this.map.setCollision(42,!0,"layer2"),this.map.setCollision(43,!0,"layer2"),this.map.setCollision(27,!0,"layer2"),this.npcs=this.game.add.group(),this.lines={dad:{1:"*Hi, son.*What are you up to?",2:"*Hi, son.*What are you up to?",3:"*Might be a lamp in the kitchen.*You should check the cupboards.",4:"*Be careful with that lamp.",7:"*Welcome back son.*Thought we lost you there."},gramps:{1:"*Hey kiddo.*What can I do for you.",2:"*You're playing with Jack?*Who's Jack?",7:"*The fall should've killed you.*There was another body down there.*Been there a while,it broke your fall."},mom:{7:"*You're okay now honey."},clara:{7:"*Why did you go down there?*Because of your imaginary friend.*He told you to, didn't he?"}},this.scene<3?(this.npcs.add(new Npc(this.game,5*tileSize-16,15*tileSize-16,"dad",9,this.lines.dad[this.scene])),this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"gramps",6,this.lines.gramps[this.scene]))):3===this.scene?(this.npcs.add(new Npc(this.game,10*tileSize,13*tileSize,"dad",3,this.lines.dad[this.scene])),this.npcs.add(this.haveLamp===!1?new Npc(this.game,7*tileSize,12*tileSize,"furniture",4,"*You take the lamp.",!1):new Npc(this.game,7*tileSize,12*tileSize,"furniture",4,"*You already have the lamp.",!1))):4===this.scene?this.npcs.add(new Npc(this.game,10*tileSize,13*tileSize,"dad",3,this.lines.dad[this.scene])):7===this.scene&&(this.npcs.add(new Npc(this.game,4*tileSize-16,3*tileSize,"dad",9,this.lines.dad[this.scene])),this.npcs.add(new Npc(this.game,3*tileSize,5*tileSize,"mom",3,this.lines.mom[this.scene])),this.npcs.add(new Npc(this.game,5*tileSize-16,15*tileSize-16,"gramps",9,this.lines.gramps[this.scene])),this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"clara",6,this.lines.clara[this.scene]))),this.physics.p2.convertTilemap(this.map,this.layer1),this.physics.p2.convertTilemap(this.map,this.layer2),this.exitPoints=this.game.add.group(),this.map.createFromObjects("objects",4,"house",3,!0,!1,this.exitPoints),this.scene<7?(player.tilex=8,player.tiley=17):(player.tilex=3,player.tiley=2),player.create(),Game.lastLocation="MyHouse",dialogue.create()},update:function(){this.exitPoints.forEach(function(e){var t=e.getBounds(),i=player.sprite.getBounds();Phaser.Rectangle.intersects(t,i)&&this.game.state.start(e.destination)},this),spaceKey.isDown&&dialogue.hidden&&this.npcs.forEach(function(e){"furniture"===e.key&&this.haveLamp===!1?e.interact()&&(this.haveLamp=!0,localStorage.setItem("haveLamp",!0),e.interact(),e.script=["","You already have the lamp."]):e.interact()},this),!spaceKey.isDown||dialogue.typing||dialogue.hidden||dialogue.hide(),player.update()}},Game.MyHouseMaybe=function(e){this.game=e},Game.MyHouseMaybe.prototype={create:function(){this.game.physics.startSystem(Phaser.Physics.P2JS),Game.music.stop(),this.scene=parseInt(localStorage.getItem("scene")),this.haveRope=JSON.parse(localStorage.getItem("haveRope")),this.haveLamp=JSON.parse(localStorage.getItem("haveLamp")),this.game.physics.p2.setBoundsToWorld(!0,!0,!0,!0,!1),Game.camera={x:0,y:1},this.game.camera.x=Game.camera.x*Game.w,this.game.camera.y=Game.camera.y*Game.h,this.game.world.setBounds(0,0,Game.w,Game.h),this.map=this.game.add.tilemap("myhouse"),this.map.addTilesetImage("house"),this.map.addTilesetImage("furniture"),this.layer1=this.map.createLayer("layer1"),this.layer1.resizeWorld(),this.layer2=this.map.createLayer("layer2"),this.layer2.resizeWorld(),this.map.setCollision(2),this.map.setCollision(12),this.map.setCollision(13),this.map.setCollision(38,!0,"layer2"),this.map.setCollision(39,!0,"layer2"),this.map.setCollision(40,!0,"layer2"),this.map.setCollision(41,!0,"layer2"),this.map.setCollision(42,!0,"layer2"),this.map.setCollision(43,!0,"layer2"),this.map.setCollision(27,!0,"layer2"),this.npcs=this.game.add.group(),this.lines={dad:{1:"*Hi, son.*What are you up to?",2:"*Hi, son.*What are you up to?",3:"*Might be a lamp in the kitchen.*You should check the drawers.",4:"*Be careful with that lamp.",7:"*Welcome back son.*Thought we lost you there."},gramps:{1:"*Hey kiddo.*What can I do for you.",2:"*You're playing with Jack?*Who's Jack?",7:"*The fall should've killed you.*There was another body down there.*Been there a while,it broke your fall.*You're very lucky."},mom:{7:"*You're okay now honey."},clara:{7:"*Why did you go down there?*Because of your imaginary friend?*He told you to, didn't he."}},this.npcs.add(new Npc(this.game,4*tileSize-16,3*tileSize,"dad",9,this.lines.dad[this.scene])),this.npcs.add(new Npc(this.game,3*tileSize,5*tileSize,"mom",3,this.lines.mom[this.scene])),this.npcs.add(new Npc(this.game,5*tileSize-16,15*tileSize-16,"gramps",9,this.lines.gramps[this.scene])),this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"clara",6,this.lines.clara[this.scene])),this.physics.p2.convertTilemap(this.map,this.layer1),this.physics.p2.convertTilemap(this.map,this.layer2),this.exitPoints=this.game.add.group(),this.map.createFromObjects("objects",4,"house",3,!0,!1,this.exitPoints),player.tilex=3,player.tiley=2,player.create(),Game.lastLocation="MyHouseMaybe",dialogue.create()},update:function(){this.exitPoints.forEach(function(e){var t=e.getBounds(),i=player.sprite.getBounds();Phaser.Rectangle.intersects(t,i)&&this.game.state.start("Darkness")},this),spaceKey.isDown&&dialogue.hidden&&this.npcs.forEach(function(e){e.interact()},this),!spaceKey.isDown||dialogue.typing||dialogue.hidden||dialogue.hide(),player.update()}},Game.Gramps=function(e){this.game=e},Game.Gramps.prototype={create:function(){this.game.physics.startSystem(Phaser.Physics.P2JS),this.scene=parseInt(localStorage.getItem("scene")),this.haveRope=JSON.parse(localStorage.getItem("haveRope")),this.haveLamp=JSON.parse(localStorage.getItem("haveLamp")),this.game.physics.p2.setBoundsToWorld(!0,!0,!0,!0,!1),Game.camera={x:0,y:1},this.game.camera.x=Game.camera.x*Game.w,this.game.camera.y=Game.camera.y*Game.h,this.game.world.setBounds(0,0,Game.w,Game.h),this.map=this.game.add.tilemap("gramps"),this.map.addTilesetImage("house"),this.map.addTilesetImage("furniture"),this.layer1=this.map.createLayer("layer1"),this.layer1.resizeWorld(),this.layer2=this.map.createLayer("layer2"),this.layer2.resizeWorld(),this.map.setCollision(2),this.map.setCollision(12),this.map.setCollision(13),this.map.setCollision(16),this.map.setCollision(17),this.map.setCollision(6),this.map.setCollision(7),this.map.setCollision(38,!0,"layer2"),this.map.setCollision(39,!0,"layer2"),this.map.setCollision(40,!0,"layer2"),this.map.setCollision(41,!0,"layer2"),this.map.setCollision(42,!0,"layer2"),this.map.setCollision(43,!0,"layer2"),this.map.setCollision(27,!0,"layer2"),this.map.setCollision(29,!0,"layer2"),this.map.setCollision(30,!0,"layer2"),this.map.setCollision(31,!0,"layer2"),this.map.setCollision(32,!0,"layer2"),this.npcs=this.game.add.group(),3===this.scene?this.haveRope===!1?(this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"gramps",0,"*Hey Kiddo.*Oh, I might have some rope.*Check the closet by the bedroom.")),this.npcs.add(new Npc(this.game,2*tileSize,3*tileSize,"furniture",4,"*You take the rope.",!1))):(this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"gramps",0,"*Hey Kiddo.*Oh, I might have some rope.*Check the closet by the bedroom.")),this.npcs.add(new Npc(this.game,2*tileSize,3*tileSize,"furniture",4,"*You already have the rope.",!1))):this.scene>3&&this.npcs.add(new Npc(this.game,2*tileSize+16,15*tileSize-16,"gramps",0,"*Hey Kiddo.*Keeping out of trouble?")),this.physics.p2.convertTilemap(this.map,this.layer1),this.physics.p2.convertTilemap(this.map,this.layer2),this.exitPoints=this.game.add.group(),this.map.createFromObjects("objects",11,"house",10,!0,!1,this.exitPoints),player.tilex=6,player.tiley=17,player.create(),Game.lastLocation="Gramps",dialogue.create()},update:function(){this.exitPoints.forEach(function(e){var t=e.getBounds(),i=player.sprite.getBounds();Phaser.Rectangle.intersects(t,i)&&this.game.state.start(e.destination)},this),spaceKey.isDown&&dialogue.hidden&&this.npcs.forEach(function(e){"furniture"===e.key&&this.haveRope===!1?e.interact()===!0&&(this.haveRope=!0,localStorage.setItem("haveRope",!0),e.script=["","You already have the rope."]):e.interact()},this),!spaceKey.isDown||dialogue.typing||dialogue.hidden||dialogue.hide(),player.update()}};var wKey,aKey,sKey,dKey;Game.Well=function(e){this.game=e},Game.Well.prototype={preload:function(){this.game.load.image("tiles","assets/images/well.png"),this.game.load.spritesheet("well","assets/images/well.png",64,64,16),this.game.load.spritesheet("player","assets/images/hero_x64.png",64,64,12)},create:function(){this.game.physics.startSystem(Phaser.Physics.P2JS),this.LIGHT_RADIUS=200;var e=42,t=30,i=new Maze(e,t);i.create();var s=i.nodes[0].room,a=i.nodes[i.nodes.length-1].room;this.game.load.tilemap("level",null,i.drawLevel(),Phaser.Tilemap.CSV),this.map=this.game.add.tilemap("level",64,64),this.map.addTilesetImage("tiles"),this.layer=this.map.createLayer(0),this.map.setCollision(0),this.map.setCollision(1),this.map.setCollision(2),this.layer.resizeWorld(),this.physics.p2.convertTilemap(this.map,this.layer),wKey=this.game.input.keyboard.addKey(Phaser.Keyboard.W),aKey=this.game.input.keyboard.addKey(Phaser.Keyboard.A),sKey=this.game.input.keyboard.addKey(Phaser.Keyboard.S),dKey=this.game.input.keyboard.addKey(Phaser.Keyboard.D),this.cursor=this.game.input.keyboard.createCursorKeys(),this.player=this.game.add.sprite(64*s.center.x,64*s.center.y,"player"),this.player.anchor.setTo(.5,.5),this.game.physics.p2.enable(this.player),this.player.body.fixedRotation=!0,this.player.body.collideWorldBounds=!0,this.game.camera.follow(this.player,Phaser.Camera.FOLLOW_PLATFORMER),this.game.physics.p2.setBoundsToWorld(!0,!0,!0,!0,!1),this.player.body.clearShapes(),this.player.body.addRectangle(16,32,0,16),this.player.direction="down",this.player.animations.add("down",[6,7],6,!0),this.player.animations.add("up",[8,9],6,!0),this.player.animations.add("right",[4,11],6,!0),this.player.animations.add("left",[5,10],6,!0),this.shadowTexture=this.game.add.bitmapData(4*this.game.width,3*this.game.height);var h=this.game.add.image(0,0,this.shadowTexture);h.blendMode=Phaser.blendModes.MULTIPLY,this.stairs=this.game.add.sprite(64*a.center.x,64*a.center.y,"well",9),this.game.physics.p2.enable(this.stairs),this.stairs.body.fixedRotation=!0,this.stairs.body.kinematic=!0},update:function(){lineDistance(this.player,this.stairs)<64&&this.game.state.start("Darkness"),this.updatePlayerMovements(),this.updateShadowTexture()},updateShadowTexture:function(){this.shadowTexture.context.fillStyle="rgb(0, 0, 100)",this.shadowTexture.context.fillRect(0,0,4*this.game.width,3*this.game.height);var e=this.LIGHT_RADIUS+this.game.rnd.integerInRange(1,10),t=this.shadowTexture.context.createRadialGradient(this.player.body.x,this.player.body.y,.75*this.LIGHT_RADIUS,this.player.body.x,this.player.body.y,e);t.addColorStop(0,"rgba(255, 255, 255, 1.0)"),t.addColorStop(1,"rgba(255, 255, 255, 0.0)"),this.shadowTexture.context.beginPath(),this.shadowTexture.context.fillStyle=t,this.shadowTexture.context.arc(this.player.body.x,this.player.body.y,e,0,2*Math.PI),this.shadowTexture.context.fill(),this.shadowTexture.dirty=!0},updatePlayerMovements:function(){this.player.body.velocity.x=0,this.player.body.velocity.y=0;var e=275;this.player.alive&&(this.tweening?(this.player.body.velocity.x=0,this.player.body.velocity.y=0):this.cursor.left.isDown||aKey.isDown?(this.player.body.velocity.x=-e,this.player.direction="left",this.player.animations.play("left")):this.cursor.right.isDown||dKey.isDown?(this.player.body.velocity.x=e,this.player.direction="right",this.player.animations.play("right")):this.cursor.up.isDown||wKey.isDown?(this.player.body.velocity.y=-e,this.player.direction="up",this.player.animations.play("up")):this.cursor.down.isDown||sKey.isDown?(this.player.body.velocity.y=e,this.player.direction="down",this.player.animations.play("down")):("up"===this.player.direction?this.player.frame=1:"down"===this.player.direction?this.player.frame=0:"right"===this.player.direction?this.player.frame=2:"left"===this.player.direction&&(this.player.frame=3),this.player.animations.stop()))}},Game.Darkness=function(e){this.game=e},Game.Darkness.prototype={preload:function(){this.game.stage.backgroundColor="#000"},create:function(){Game.camera={x:0,y:0},this.scene=parseInt(localStorage.getItem("scene")),this.haveRope=JSON.parse(localStorage.getItem("haveRope")),this.scene<6&&(this.jack=this.game.add.sprite(Game.w/2-32,Game.h/2-32,"jack"),this.jack.frame=12,Game.music.stop(),Game.music=this.game.add.sound("tomb"),Game.music.volume=.5,Game.music.play("",0,1,!0)),this.haveLamp=JSON.parse(localStorage.getItem("haveLamp")),dialogue.create(),dialogue.hidden=!0,this.restartText=this.game.add.bitmapText(Game.w/2,Game.h/2-200,"minecraftia","",21),this.restartText.x=this.game.width/2-this.restartText.textWidth/2-175},update:function(){switch(this.scene){case 4:dialogue.hidden&&dialogue.show(this,["","...","Wake up!","It's time to play.","Get to the stairs, if you can."]),!spaceKey.isDown||dialogue.typing||dialogue.hidden||(this.scene=5,localStorage.setItem("scene","5"),dialogue.hide(),this.game.state.start("Well"));break;case 5:dialogue.hidden&&dialogue.show(this,["","Not what you expected right?","You died, you know.","You fell, just like me.","There's no way out.  Not really."]),!spaceKey.isDown||dialogue.typing||dialogue.hidden||(this.scene=6,localStorage.setItem("scene","6"),dialogue.hide(),this.game.state.start("Well"));break;case 6:dialogue.hidden&&dialogue.show(this,["","Wake up!","Wake up son! Wake up!"]),!spaceKey.isDown||dialogue.typing||dialogue.hidden||(this.scene=7,localStorage.setItem("scene","7"),dialogue.hide(),dialogue.hidden=!0,this.game.state.start("MyHouseMaybe"));break;case 7:if(dialogue.hidden&&dialogue.show(this,["","There's no way out.","Not really...","THE END."]),spaceKey.isDown&&!dialogue.typing&&!dialogue.hidden){var e="You survived... or did you?\n";e+="~Share on twitter!~\n",this.restartText.setText(e),this.restartText.visible=!0,this.twitterButton=this.game.add.button(Game.w/2,Game.h/2-100,"twitter",this.twitter,this),this.twitterButton.anchor.setTo(.5,.5),this.twitterButton.fixedToCamera=!0,localStorage.setItem("scene","1"),localStorage.setItem("haveLamp",!1),localStorage.setItem("haveRope",!1)}}},twitter:function(){window.open("http://twitter.com/share?text=I+escaped+The+Well!+See+if+you+can+make+it+out+at&via=rantt_&url=http://www.divideby5.com/games/the_well/","_blank")}};var game=new Phaser.Game(Game.w,Game.h,Phaser.AUTO,"game");
game.state.add("Boot",Game.Boot),game.state.add("Load",Game.Load),game.state.add("Menu",Game.Menu),game.state.add("Town",Game.Town),game.state.add("MyHouse",Game.MyHouse),game.state.add("MyHouseMaybe",Game.MyHouseMaybe),game.state.add("Gramps",Game.Gramps),game.state.add("Well",Game.Well),game.state.add("Darkness",Game.Darkness),game.state.start("Boot");